"use strict";angular.module("compromisosSiteApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngYoutubeEmbed"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",controllerAs:"home"}).when("/c01",{templateUrl:"views/c01.html",controller:"Compromiso01Ctrl",controllerAs:"c01"}).otherwise({redirectTo:"/"})}]).service("UrlService",function(){this.baseUrl="http://palamago.com.ar/api/",this.urls={home:this.baseUrl+"?source_format=csv&source=https://goo.gl/Cid4QS"},this.getUrlByPage=function(a){return this.urls[a]+"&callback=JSON_CALLBACK"},this.getUrlByCsv=function(a){return this.baseUrl+"?source_format=csv&source="+a+"&callback=JSON_CALLBACK"}}),angular.module("compromisosSiteApp").controller("HomeCtrl",["$scope","$timeout","$http","UrlService",function(a,b,c,d){function e(a){for(var b=0,c=0;c<x.length;c++){var d=x[c],e=parseInt(a.porcentaje_completado);if(e>=d.from&&e<d.to){b=c;break}}return a.percentageGroup=b,b}function f(a){var b={"protección e integración social":"social",convivencia:"convivencia","hábitat y movilidad":"movilidad","ciudad inteligente y sustentable":"smart"};return b[a.toLowerCase()]}function g(b,c,d){b.porcentaje=Math.round(Math.floor(99*Math.random())+2),a.$apply(function(){a.currentCompromise=b});var e=parseInt(d3.select("#compromiso-detail").style("height").replace("px","")),f=parseInt($(window).height()),g=parseInt(d.clientY);d3.select("#compromiso-detail").style("top",d.clientY+"px");var h=g+e-f;h>0&&d3.select("#filler").style("height",h+"px")}function h(){var b=["x"].concat(a.availableYears);angular.forEach(a.categoriesGroup,function(a){a.years=d3.nest().key(function(a){return a.cumplimiento1}).rollup(function(a){return a.length}).entries(a.values)});var c=[];c.push(b),angular.forEach(a.categoriesGroup,function(b){var d=[];d.push(b.key),angular.forEach(a.availableYears,function(a){for(var c=0,e=0;e<b.years.length;e++){var f=b.years[e];if(a===f.key){c=f.values;break}}d.push(c)}),c.push(d)}),a.charts.date_chart=c3.generate({bindto:"#date_chart",data:{x:"x",columns:c,type:"bar",groups:[a.availableCategories],colors:angular.copy(a.colorsByCategory)},size:{width:300,height:220},padding:{top:20,right:20,bottom:20,left:20},legend:{show:!1},axis:{x:{type:"category"},y:{show:!1}},grid:{y:{lines:[{value:0}]}}})}function i(){var b=["x","0%-25%","25%-50%","50%-75%","75%-100%"];angular.forEach(a.categoriesGroup,function(a){a.percentages=d3.nest().key(function(a){return a.percentageGroup}).rollup(function(a){return a.length}).entries(a.values)});var c=[];c.push(b),angular.forEach(a.categoriesGroup,function(a){var b=[];b.push(a.key),angular.forEach(x,function(c,d){for(var e=0,f=0;f<a.percentages.length;f++){var g=a.percentages[f];if(d===parseInt(g.key)){e=g.values;break}}b.push(e)}),c.push(b)}),a.charts.state_chart=c3.generate({bindto:"#state_chart",data:{x:"x",columns:c,type:"bar",groups:[a.availableCategories],colors:angular.copy(a.colorsByCategory)},size:{width:300,height:220},padding:{top:20,right:20,bottom:20,left:20},legend:{show:!1},axis:{x:{type:"category"},y:{max:10,show:!1,padding:{top:0,bottom:0}}},grid:{y:{lines:[{value:0}]}}})}function j(){k(a.colorsByCategory)}function k(b){a.charts.state_chart.data.colors(b),a.charts.date_chart.data.colors(b)}function l(b){var c={social:"#e6e6e6",convivencia:"#e6e6e6",movilidad:"#e6e6e6",smart:"#e6e6e6"};c[b]=a.colorsByCategory[b],k(c)}function m(){var b=220,c=(d3.scale.category20b(),d3.format(",d"),d3.layout.pack().sort(null).size([b,b]).value(function(a){return parseInt(a.porcentaje_completado)}));a.charts.category_chart||(a.charts.category_chart={},a.charts.category_chart.svg=d3.select("#category_chart").append("svg").attr("class","bubble-container").attr("width",300).attr("height",220));for(var d=a.charts.category_chart.svg,e={name:"categories",children:[]},f=0;f<a.categoriesGroup.length;f++){var g=a.categoriesGroup[f];e.children.push({name:g.key,children:g.values})}var h=d.datum(e).selectAll(".node").data(c.nodes).enter().append("g").attr("class",function(a){var b=a.children?"node":"leaf node",c=a.slug?a.slug:a.name;return b+" "+c}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});h.append("title").text(function(a){return a.name+(a.children?"":": "+parseInt(a.porcentaje_completado))}),h.append("circle").attr("r",function(a){return a.r}).filter(function(a){return"categories"!==a.name}).style("fill",function(b){return a.colorsByCategory[b.slug]})}function n(){function b(){a.charts.menu_chart.svg.transition().duration(w).attr("width",u).attr("height",v)}function c(){u=$(window).width(),y=768>u;Math.floor(u/n);z=0;var c=d(a.charts.menu_chart.items_group.selectAll("g.compromiso-item"),0);v=c*n,b(),k([])}function d(a,b,c){b+=y&&c?n:0,z=y?0:z;var d=Math.floor((u-z)/n),e=0,f=0,g=(u-z-d*n)/2;return a.transition().duration(w).attr("transform",function(c,h){var i=e*n+g+z,j=f*n+b;return d-1>e?e++:a[0].length!=h+1&&(e=0,f++),"translate("+i+","+j+")"}),f+1+(y&&c?1:0)}function h(){u=$(window).width(),y=768>u;var c=0;z=u/3;var e=[];angular.forEach(a.finishedPercentageGroup,function(b){e.push({title:x[b.key].from+"% - "+x[b.key].to+"%",rows:c}),c+=d(a.charts.menu_chart.items_group.selectAll("g.avance-"+b.key),c*n,!0)}),v=c*n,b(),k(e)}function i(){u=$(window).width(),y=768>u;var c=0;z=u/3;var e=[];angular.forEach(a.categoriesGroupText,function(b){e.push({title:b.key,rows:c}),c+=d(a.charts.menu_chart.items_group.selectAll("g.categoria-"+f(b.key)),c*n,!0)}),v=c*n,b(),k(e)}function j(){u=$(window).width(),y=768>u;var c=0;z=u/3;var e=[];angular.forEach(a.finishedYearsGroup,function(b){e.push({title:b.key,rows:c}),c+=d(a.charts.menu_chart.items_group.selectAll("g.cumplimiento-"+b.key),c*n,!0)}),v=c*n,b(),k(e)}function k(b){a.charts.menu_chart.labels_group.selectAll("*").remove();var c=a.charts.menu_chart.labels_group.selectAll(".label-group").data(b);c.enter().append("g").classed("label-group",!0).each(function(a,b){var c=d3.select(this);c.append("rect").classed("label-group-shape",!0).classed("shape",!0).attr("height",n).attr("width",y?u:u/3).attr("fill","none"),c.append("text").classed("label-group-text",!0).classed("wrap",!0).attr("text-anchor","start").attr("opacity",1).text(function(a){return a.title}),c.attr("transform",function(){return"translate(0,"+a.rows*n+")"});var d=c.select("text");d3plus.textwrap().container(d).shape("square").align("left").valign("middle").padding(3).draw()})}function l(){var b={width:n,height:n/3};d3plus.textwrap().config(b),a.charts.menu_chart.items_group.selectAll("g.compromiso-item").data(A).enter().append("g").attr("class",function(a){var b=[];return b.push("cumplimiento-"+a.cumplimiento1),b.push("categoria-"+a.slug),b.push("categoria-unselected"),b.push("avance-"+e(a)),b.join(" ")}).classed("compromiso-item",!0).attr("id",function(a){return"c"+a.numero}).each(function(b){var c=d3.select(this);c.append("rect").classed("compromiso-frame",!0).attr("x",0).attr("y",0).attr("height",n).attr("width",n).attr("fill","white"),c.append("rect").classed("compromiso-label-shape",!0).classed("shape",!0).attr("x",t).attr("y",n/2).attr("height",n/2-t).attr("width",n-2*t).attr("fill","none"),c.append("text").classed("compromiso-label",!0).classed("wrap",!0).attr("id","c"+b.numero+"-text").attr("opacity",0).text(function(){return b.titulo}),c.append("g").classed("compromiso-icon",!0).attr("id",function(a){return"c"+a.numero+"-icon"}).attr("transform",function(a,b){var c=n/2-25,d=n/3-25;return"translate("+c+","+d+")"}).each(function(b){var c="images/iconos/GCBA-compromisos-icons-"+b.icono+".svg",d=this;d3.xml(c,"image/svg+xml",function(b,e){var f=document.importNode(e.documentElement,!0);f=$(f).attr("width",50).attr("height",50).get(0),a.iconsSvg[c]=f,d.appendChild(a.iconsSvg[c].cloneNode(!0))})}),c.append("rect").classed("compromiso-action",!0).attr("x",t).attr("y",t).attr("height",n-2*t).attr("width",n-2*t).attr("fill","transparent").on("mouseover",function(a){r(a.slug),o(a.numero)}).on("mouseout",function(a){s(),p();var b=$(".c-option-selected");b.size()&&q(b.data("slug"))}).on("click",function(a,c){g(b,d3.mouse(this),d3.event)})}).transition().duration(0).attr("transform",function(a,b){var c=u/2-n/2,d=v/2-n/2;return"translate("+c+","+d+")"}).each("end",function(a){var b=d3.select("text#c"+a.numero+"-text");d3plus.textwrap().container(b).shape("square").align("center").valign("top").padding(3).draw(),b.transition().attr("opacity",1)})}function m(){l(),a.charts.menu_chart.api={group:function(a){switch(a){case"home":c();break;case"date":j();break;case"category":i();break;case"state":h()}}},setTimeout(function(){a.charts.menu_chart.api.group(a.selectedGroup)},1e3)}var n=150,t=5,u=$(window).width(),v=500,w=500,y=768>u,z=u/3,A=angular.copy(a.data);a.charts.menu_chart||(a.charts.menu_chart={},a.charts.menu_chart.svg=d3.select("#menu_chart").append("svg").attr("width",u).attr("height",v).attr("class","menu_chart"),a.charts.menu_chart.items_group=a.charts.menu_chart.svg.append("g").classed("items-container",!0),a.charts.menu_chart.labels_group=a.charts.menu_chart.svg.append("g").classed("labels-container",!0)),m()}function o(a){$(".compromiso-item").addClass("categoria-unselected"),$(".compromiso-item#c"+a).removeClass("categoria-unselected")}function p(){$(".compromiso-item").addClass("categoria-unselected")}function q(a){$(".compromiso-item").addClass("categoria-unselected"),$(".compromiso-item.categoria-"+a).removeClass("categoria-unselected")}function r(a){$(".c-option").removeClass("c-option-hover"),$('.c-option[data-slug="'+a+'"]').addClass("c-option-hover")}function s(){$(".c-option").removeClass("c-option-hover")}function t(a){$(".c-option").removeClass("c-option-selected"),$('.c-option[data-slug="'+a+'"]').addClass("c-option-selected")}function u(){$(".c-option").removeClass("c-option-selected")}function v(){$(".c-option").mouseover(function(){var a=$(this).data("slug");a&&(r(a),q(a),l(a))}).mouseout(function(){var a=$(this).data("slug");if(a){var b=$(".c-option-selected");b.size()?(q(b.data("slug")),l(b.data("slug"))):(p(),j()),s()}}).click(function(){var b=$(this).data("slug");if(b)if($(this).hasClass("c-option-selected"))u(),j();else{var b=$(this).data("slug");t(b),q(b),l(b),a.$apply(function(){a.selectedCategory=b})}})}new pym.Child({polling:1e3});a.data=[],a.loading=!0,a.charts={},a.iconsSvg={},a.selectedGroup="home";var w=d.getUrlByPage("home");c.jsonp(w).success(function(b){a.data=b.map(function(a){return a.slug=f(a.categoria),a}),a.loading=!1,a.groupData(),a.renderCharts()}),a.groupData=function(){a.categoriesGroup=d3.nest().key(function(a){return a.slug}).entries(a.data),a.categoriesGroupText=d3.nest().key(function(a){return a.categoria}).entries(a.data),a.availableCategories=[],angular.forEach(a.categoriesGroup,function(b){a.availableCategories.push(b.key)}),angular.forEach(a.categoriesGroup,function(a){a.finishedYearsGroup=d3.nest().key(function(a){return a.cumplimiento1}).rollup(function(a){return a.length}).entries(a.values)}),a.finishedYearsGroup=d3.nest().key(function(a){return a.cumplimiento1}).entries(a.data),angular.forEach(a.finishedYearsGroup,function(a){a.categoryGroup=d3.nest().key(function(a){return f(a.categoria)}).rollup(function(a){return a.length}).entries(a.values)}),a.availableYears=[],angular.forEach(a.finishedYearsGroup,function(b){a.availableYears.push(b.key)}),a.finishedPercentageGroup=d3.nest().key(function(a){return e(a)}).entries(a.data)};var x=[];x.push({from:0,to:25}),x.push({from:25,to:50}),x.push({from:50,to:75}),x.push({from:75,to:100}),a.colorsByCategory={social:"#fccf2b",convivencia:"#3abaaf",movilidad:"#f58b45",smart:"#7c4194"},a.renderCharts=function(){v(),h(),i(),m(),n()},a.closeDetail=function(){a.currentCompromise=null,d3.select("#filler").style("height","0px")},a.onChangeCategory=function(){""!=a.selectedCategory?(t(a.selectedCategory),q(a.selectedCategory),l(a.selectedCategory)):(u(),j())},a.onChangeGroup=function(){a.groupMenu(a.selectedGroup)},a.groupMenu=function(b){a.selectedGroup=b,a.charts.menu_chart.api.group(a.selectedGroup)};var y;$(window).resize(function(){clearTimeout(y),y=setTimeout(function(){a.charts.menu_chart&&a.charts.menu_chart.api.group(a.selectedGroup),a.charts.category_chart&&m()},500)})}]),angular.module("compromisosSiteApp").controller("Compromiso01Ctrl",["UrlService","$scope","$http",function(a,b,c){var d=a.getUrlByPage("home");new pym.Child({polling:1e3});b.loading=!0,c.jsonp(d).success(function(a){b.currentCompromise=b.data=_.find(a,function(a){return 1===parseInt(a.numero)}),b.loading=!1,console.log(a)}),b.youtubeLink="https://www.youtube.com/watch?v=AoZ98-TwqM4",b.completeConfig=function(a){return console.log("pasa complete config"),angular.merge(a,{data:{keys:{value:["baches"],x:"ano"}},axis:{x:{label:"Año"},y:{label:"Baches arreglados"}}})},b.prepareData=function(a){return a}}]),angular.module("compromisosSiteApp").directive("smartContent",function(){return{restrict:"E",replace:!0,scope:{url:"=url",dataCallback:"=dataCallback",configCallback:"=configCallback",template:"=template"},controller:["$scope","$timeout","UrlService","$http",function(a,b,c,d){function e(a){return null!=a.match(/\b\w*(youtu)\w*\b/)}function f(a){return null!=a.match(/\.(jpeg|jpg|gif|png)$/)}a.loading=!0,a.id="content-"+Math.floor(1e4*Math.random()),a.getTemplateUrl=function(){return a.template?a.template:e(a.url)?(a.loading=!1,"views/directives/youtubePlayer.html"):f(a.url)?(a.loading=!1,"views/directives/imageFull.html"):"views/directives/simpleChart.html"},a.chartConfigDefaults={data:{json:[]}},a.renderChart=function(){var e=c.getUrlByCsv(a.url);console.log("renderChart"),a.chartConfigDefaults.bindto="#"+a.id,d.jsonp(e).success(function(c){a.dataCallback?a.chartConfigDefaults.data.json=a.dataCallback(c):a.chartConfigDefaults.data.json=c,a.configCallback&&(a.chartConfigDefaults=a.configCallback(a.chartConfigDefaults)),b(function(){console.log(JSON.stringify(a.chartConfigDefaults)),c3.generate(a.chartConfigDefaults),a.loading=!1},500)})}}],template:'<ng-include src="getTemplateUrl()"/>'}}),angular.module("compromisosSiteApp").run(["$templateCache",function(a){a.put("views/c01.html",'<p class="text-center" ng-show="loading">Cargando...</p> <div ng-hide="loading"> <div class="row"> <div ng-include="\'views/includes/detail.html\'" id="compromiso-detail" class="row well" ng-cloak ng-show="currentCompromise"> </div> <div ng-if="data.detalle_1" class="col-md-6 text-center"> <smart-content url="data.detalle_1" template=""></smart-content> </div> <div ng-if="data.detalle_2" class="col-md-6 text-center"> <smart-content url="data.detalle_2"></smart-content> </div> <div ng-if="data.detalle_3" class="col-md-6 text-center"> <smart-content url="data.detalle_3" data-callback="prepareData" config-callback="completeConfig"></smart-content> </div> <div ng-if="data.detalle_4" class="col-md-6 text-center"> <smart-content url="data.detalle_4"></smart-content> </div> </div> </div>'),a.put("views/directives/imageFull.html",'<span ng-show="loading">Cargando...</span> <img ng-hide="loading" ng-src="{{url}}" class="img-responsive">'),a.put("views/directives/simpleChart.html",'<span ng-show="loading">Cargando...</span> <div id="{{id}}" ng-init="renderChart()"></div>'),a.put("views/directives/youtubePlayer.html",'<ng-youtube-embed url="url" autoplay color="white" disablekb="true" end="20"> </ng-youtube-embed>'),a.put("views/home.html",'<div class="row hidden-device"> <div class="col-sm-3 c-option c-color-smart" data-slug="smart"> <h3 class="text-center">Ciudad inteligente y sustentable</h3> </div> <div class="col-sm-3 c-option c-option-short c-color-convivencia" data-slug="convivencia"> <h3 class="text-center">Convivencia</h3> </div> <div class="col-sm-3 c-option c-option-short c-color-movilidad" data-slug="movilidad"> <h3 class="text-center">Hábitat y movilidad</h3> </div> <div class="col-sm-3 c-option c-color-social" data-slug="social"> <h3 class="text-center">Protección e integración social</h3> </div> </div> <div class="row hidden-desktop"> <div class="col-xs-3 c-option c-color-smart"></div> <div class="col-xs-3 c-option c-color-convivencia"></div> <div class="col-xs-3 c-option c-color-movilidad"></div> <div class="col-xs-3 c-option c-color-social"></div> </div> <div class="row hidden-desktop select-container"> <div class="col-xs-12"> <select ng-change="onChangeCategory()" ng-model="selectedCategory" class="form-control"> <option value="">Elegir categoría</option> <option value="smart">Ciudad inteligente y sustentable</option> <option value="convivencia">Convivencia</option> <option value="movilidad">Hábitat y movilidad</option> <option value="social">Protección e integración social</option> </select> </div> <hr> <div class="col-xs-12"> <select ng-change="onChangeGroup()" ng-model="selectedGroup" class="form-control"> <option value="home">Ordenar por nombre</option> <option value="date">Ordenar por fecha fin</option> <option value="state">Ordenar por estado</option> <option value="category">Ordenar por categoría</option> </select> </div> </div> <hr> <div class="row"> <div class="col-sm-3 hidden-device" ng-class="{\'display\':(selectedGroup==\'home\')}"> <a class="group-btn" ng-click="groupMenu(\'home\')"></a> <p class="btn-checkbox hidden-device" ng-class="{\'selected\':(selectedGroup==\'home\')}">Ordenar por nombre</p> <div id="home_chart"> <p class="text-center" ng-cloak ng-show="loading">Cargando...</p> </div> <small class="text-center">Vista general de los compromisos</small> </div> <div class="col-sm-3 hidden-device" ng-class="{\'display\':(selectedGroup==\'date\')}"> <a class="group-btn" ng-click="groupMenu(\'date\')"></a> <p class="btn-checkbox hidden-device" ng-class="{\'selected\':(selectedGroup==\'date\')}">Ordenar por fecha de fin</p> <div id="date_chart"> <p class="text-center" ng-cloak ng-show="loading">Cargando...</p> </div> <small class="text-center">Cantidad de compromisos por año de finalización</small> </div> <div class="col-sm-3 hidden-device" ng-class="{\'display\':(selectedGroup==\'state\')}"> <a class="group-btn" ng-click="groupMenu(\'state\')"></a> <p class="btn-checkbox hidden-device" ng-class="{\'selected\':(selectedGroup==\'state\')}">Ordenar por estado</p> <div id="state_chart" ng-click="groupMenu(\'state\')"> <p class="text-center" ng-cloak ng-show="loading">Cargando...</p> </div> <small class="text-center">Cantidad de compromisos por estado de progreso</small> </div> <div class="col-sm-3 hidden-device" ng-class="{\'display\':(selectedGroup==\'category\')}"> <a class="group-btn" ng-click="groupMenu(\'category\')"></a> <p class="btn-checkbox hidden-device" ng-class="{\'selected\':(selectedGroup==\'category\')}">Ordenar por categoría</p> <div id="category_chart" ng-click="groupMenu(\'category\')"> <p class="text-center" ng-cloak ng-show="loading">Cargando...</p> </div> <small class="text-center">Cantidad de compromisos por categoría de pertenencia</small> </div> </div> <hr> <p class="text-center" ng-show="loading">Cargando...</p> <div ng-cloak ng-hide="loading"> <div class="row"> <div id="menu_chart"></div> </div> <hr> <div ng-include="\'views/includes/detail.html\'" id="compromiso-detail" class="row well" ng-cloak ng-show="currentCompromise"> </div> <div id="filler" class="hidden-desktop"></div> </div> <hr>'),a.put("views/includes/detail.html",'<a class="hidden-desktop" ng-click="closeDetail()">Cerrar</a> <div class="col-sm-3"> <img src="http://wizardofodds.com/blog/images/buenos-aires/IMG_0471-med.jpg"> </div> <div class="col-sm-6"> <h2><small>{{currentCompromise.categoria}}</small></h2> <h2>{{currentCompromise.numero}}.{{currentCompromise.titulo}}</h2> <h5>{{currentCompromise.cumplimiento}}</h5> <p> {{currentCompromise.desc}}</p> <button type="button" class="btn btn-xs btn-violet upper">Ver mas sobre el compromiso </button> </div> <div class="col-sm-3"> <p class="upper"><strong> Estado del Compromiso</strong></p> <p> Como lo medimos:<strong>Cantidad de plazas</strong> </p> <p> Tiempo Faltante:<strong>18 meses y 12 dias </strong> </p> <div class=""> <div class="progress"> <div class="progress-bar progress-bar-violet" role="progressbar" ng-style="{ \'width\': currentCompromise.porcentaje + \'%\' }"> <span>{{currentCompromise.porcentaje}}% </span> </div> </div> </div> <p>Finalizacion:<strong> {{currentCompromise.FechaFinalizacion}} </strong> </p> <a class="hidden-desktop" ng-click="closeDetail()">Cerrar</a> </div> ')}]);